
<p>‚è∞ Lab time is 20 min | <a href="https://yugabyte.slack.com/archives/C03176Y6BU0" target="_blank">slack feedback</a></p>
<hr>

<h2 id="about-this-lab">About this lab</h2>
<p>In this lab, you will run a couple of the workloads in the the <strong>Yahoo! Cloud Serving Benchmark (YCSB)</strong> for Yugabyte. The lab consists of these activities and uses the YSQL API:</p>
<ul>
<li>Download and install the Yugabyte Client</li>
<li>Download and install the Yugabyte YCBS benchmark</li>
<li>Run individual workloads</li>
<li>Experiment on your own</li>
<li>Clean up</li>
</ul>
<h3 id="about-ycsb">About YCSB</h3>
<p>The <a href="https://github.com/brianfrankcooper/YCSB/wiki">Yahoo! Cloud Serving Benchmark (YCSB)</a> consists of the YCSB client and the Core workload. The YCSB client is an extensible workload generator which runs not only the Core workload but also any custom workloads. YCSB supports running benchmarks for many databases.</p>
<p>The YCSB client is a Java program and ideally runs on at least one dedicated host. The number of CPU cores determines the upper thread count limits for both the loading and execution phases of the workload. For large database clusters, the benchmark often requires multiple YCSB clients running on individual dedicated hosts.</p>
<p>The Core workload defines a simple mix of read, insert, update, and scan operations. A parameter file and workload properties defines the relative frequency of each operation.  For the Core workload, the YCSB Client assumes that there is a default database table named <code>usertable</code>. By design, the <code>usertable</code> table is a flexible schema and allows for additional columns at runtime.</p>
<p>The YCSB client supports three commands:</p>
<ul>
<li>load</li>
<li>run</li>
<li>shell</li>
</ul>
<p>The load and run commands require a binding properties reference to a specific database. The load command requires a workload file and optional parameters. The load command processes the loading section of the workload file. The run command is similar in signature to the load command parameters. However, the run command processes the transaction section of the workload file. The shell command serves as a shell for the defined database. Basic is the default database definition. As there is no database for Basic, you can use Basic to test that the YCSB client is available on a host.</p>
<h3 id="about-the-ycsb-for-yugabyte">About the YCSB for Yugabyte</h3>
<p>The <a href="https://github.com/yugabyte/YCSB">YCSB for Yugabyte</a> is a fork of the original YCSB. The YCSB for Yugabyte supports running YSQL and YQCL workloads.</p>
<p>You can run the YCSB for Yugabyte in several ways. One way is to use the utility shell scripts, <code>run_jdbc.sh</code>, <code>run_ycql.sh</code>, and <code>run_ysql.sh</code>. The utility scripts load the data for and then run each workload in the the <code>workloads</code> directory. The scripts support the following arguments:</p>
<pre><code><code><div>--ip                         IP of node to connect to
--recordcount                Number of rows
</div></code></code></pre>
<p>YCSB for Yugabyte contains the following bindings:</p>
<table>
<thead>
<tr>
<th>Binding</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>YugabyteCQL</td>
<td>This binding contains the related JARs to enable YCSB to work with YugabyteDB using YCQL.</td>
</tr>
<tr>
<td>YugabyteSQL</td>
<td>This contains the related JARs to enable YCSB to work with YugabyteDB using YSQL.</td>
</tr>
<tr>
<td>YugabyteSQL2Keys</td>
<td>This binding uses 2 column keys and supports <code>workloade</code>. The drivers support YSQL.</td>
</tr>
</tbody>
</table>
<p>YCSB for Yugabyte also contains a <code>db.properties</code> file. Modify this file to specify connection properties to your database for both YSQL and YCQL.</p>
<h3 id="requirements">Requirements</h3>
<p>The utility scripts in YCSB for Yugabyte require the YSQL and YCQL shells. You must download these shells to your YCSB EC2 host. You must also add these shells to the your PATH variable. In order to complete this lab, you'll need the following:</p>
<ul>
<li>Your AWS Account</li>
<li>A Yugabyte Universe managed by Yugabyte Platform</li>
<li>A YCSB EC2 host running Centos 7 or similar in your VPC dedicated with the following installed:
<ul>
<li>Java 1.8 (open JDK is fine)</li>
<li>ysqlsh and/or ycqlsh</li>
</ul>
</li>
</ul>
<h2 id="download-and-install-the-yugabyte-client">Download and install the Yugabyte Client</h2>
<p>The Yugabyte Client contains both the YCQL and YSQL Shells.</p>
<ul>
<li>Using your <code>.pem</code> key, secure shell into your YCSB EC2 host, replacing the values for <strong>PUBLIC_IPV4_HOST_YCSB</strong> and <strong>kp-NAME-aws.pem</strong>.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">PUBLIC_IPV4_HOST_YCSB = &#x27;&lt;PUBLIC_IPV4_HOST_YCSB&gt;&#x27;
MY_PEM_FILE = &#x27;&lt;kp-NAME-aws.pem&gt;&#x27;

ssh -i ~/.ssh/<span class="hljs-variable">${MY_PEM_FILE} centos@<span class="hljs-variable">${PUBLIC_IPV4_EC2_TPCC}

</code></pre></div>
<ul>
<li>Once connected, install <code>wget</code> and Java, if needed.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">sudo yum install -y wget java
</code></pre></div>
<ul>
<li>Download the Yugabyte Client.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cd /tmp
wget -q -O - https://downloads.yugabyte.com/get_clients.sh | sh 

</code></pre></div>
<ul>
<li>Add <code>ysqlsh</code> to your path.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">export PATH=<span class="hljs-variable">$PATH:/tmp/yugabyte-client-2.6/ysqlsh
</code></pre></div>
<ul>
<li>Optionally, add <code>ycqlsh</code> to your path.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">export PATH=<span class="hljs-variable">$PATH:/tmp/yugabyte-client-2.6/ycqlsh
</code></pre></div>
<h2 id="download-and-install-the-yugabyte-ycbs-benchmark">Download and install the Yugabyte YCBS benchmark</h2>
<p>Follow these steps to download and install the benchmark on your EC2 host where you will run the YCSB benchmark.</p>
<ul>
<li>On your YCSB EC2 host, download and uncompress the <code>tpcc.targ.gz</code> file.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cd /tmp
wget https://github.com/yugabyte/YCSB/releases/download/1.0/ycsb.tar.gz
tar -zxvf ycsb.tar.gz
<span class="hljs-built_in">cd YCSB/
ls -l
</code></pre></div>
<h3 id="configure-the-ycsb-database-properties-file">Configure the YCSB database properties file</h3>
<p>Prior to loading data and running a benchmark, you need to configure the YCSB application to connect to your cluster. It is important to specify connection strings for all the nodes in the Yugabyte cluster. Here are the steps to follow for YSQL:</p>
<ul>
<li>Using VIM, edit the <code>db.properties</code> file in the YCSB directory <code>[i = Insert mode ]</code>.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">vim db.properties
</code></pre></div>
<ul>
<li>For the <code>db.url</code>, specify the connection string for each Yugabyte cluster node. Use the Private IPv4 address for each node. Use a semi-colon (<code>;</code>) delimiter for the connection strings.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">db.url=jdbc:postgresql://&lt;PRIVATE_IPV4_YB_NODE_1&gt;:5433/ycsb;jdbc:postgresql://&lt;PRIVATE_IPV4_YB_NODE_2&gt;:5433/ycsb;jdbc:postgresql://&lt;PRIVATE_IPV4_YB_NODE_3&gt;:5433/ycsb
</code></pre></div>
<ul>
<li>Change both the value of <code>db.user</code> and <code>db.passwd</code> to administrator user or similar user.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">db.user=&lt;MY_DATABASE_USER&gt;
db.passwd=&lt;MY_DATABASE_USER_PASSWORD&gt;
</code></pre></div>
<ul>
<li>
<p>Save your changes <code>[ esc = Read-only mode  |  :wq! = force save quit ]</code> and exit.</p>
</li>
<li>
<p>Verify your changes.</p>
</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cat db.properties
</code></pre></div>
<h2 id="run-individual-workloads">Run individual workloads</h2>
<p>Rather than running all the workloads in YCSB, you will run workloads individually. To run an individual workload, you will first create the <code>ycsb</code> database and the <code>usertable</code> table.</p>
<h3 id="create-the-ycsb-database-and-usertable-table">Create the ycsb database and usertable table</h3>
<p>Using the <code>ysqlsh</code> client, connect to a node in your Yugabyte cluster and create the <code>ycsb</code> database. Here are the steps:</p>
<ul>
<li>Connect to your database with <code>ysqlsh</code>, replacing the values for <strong>MY_DATABASE_USER</strong> and <strong>PRIVATE_IPV4_YB_NODE_1</strong>.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">MY_DATABASE_USER = &#x27;yugabyte&#x27;
PRIVATE_IPV4_YB_NODE_1 = &#x27;&lt;PRIVATE_IPV4_YB_NODE_1&gt;&#x27;&#x27;
cd /tmp/yugabyte-client-2.6/bin/
./ysqlsh -h ${PRIVATE_IPV4_YB_NODE_1} -d yugabyte -U ${MY_DATABASE_USER}
</code></pre></div>
<ul>
<li>In YSQL Shell, create the <strong>ycsb</strong> database.</li>
</ul>
<div class="highlight"><pre><code class="language-sql">CREATE DATABASE ycsb;
</code></pre></div>
<ul>
<li>Next, connect to the database and create the <strong>usertable</strong> table.</li>
</ul>
<div class="highlight"><pre><code class="language-sql">\c ycsb

CREATE TABLE usertable (
  YCSB_KEY <span class="hljs-built_in">VARCHAR(<span class="hljs-number">255) PRIMARY KEY,
  FIELD0 <span class="hljs-built_in">TEXT, 
  FIELD1 <span class="hljs-built_in">TEXT, 
  FIELD2 <span class="hljs-built_in">TEXT, 
  FIELD3 <span class="hljs-built_in">TEXT,
  FIELD4 <span class="hljs-built_in">TEXT,
  FIELD5 <span class="hljs-built_in">TEXT,
  FIELD6 <span class="hljs-built_in">TEXT,
  FIELD7 <span class="hljs-built_in">TEXT,
  FIELD8 <span class="hljs-built_in">TEXT,
  FIELD9 <span class="hljs-built_in">TEXT);

exit;
</code></pre></div>
<h3 id="load-the-data-for-a-workload">Load the data for a workload</h3>
<p>After creating the database and the table, you need to load the data for the workload. The workload in this step is <code>workloada</code>. Here are the steps:</p>
<ul>
<li>Using the <code>load</code> command, load the data for <code>workloada</code>.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cd /tmp/YCSB/
./bin/ycsb load yugabyteSQL -s \
  -P db.properties  \
  -P workloads/workloada  \
  -p recordcount=10000  \
  -p operationcount=100000  \
  -p threadcount=32  \
  -p maxexecutiontime=180

</code></pre></div>
<ul>
<li>Verify the success of the load</li>
</ul>
<div class="highlight"><pre><code class="language-bash">[INSERT], Return=OK, 10000
</code></pre></div>
<ul>
<li>Next, you can run the workload.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cd /tmp/YCSB/
./bin/ycsb run yugabyteSQL -s \
  -P db.properties  \
  -P workloads/workloada  \
  -p recordcount=10000  \
  -p operationcount=100000  \
  -p threadcount=64  \
  -p maxexecutiontime=180

</code></pre></div>
<ul>
<li>Review the results of the workload benchmark.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">[OVERALL], RunTime(ms), 15635
[OVERALL], Throughput(ops/sec), 1603.1232133351
</code></pre></div>
<ul>
<li>Run workloadb and review the benchmark results.</li>
</ul>
<div class="highlight"><pre><code class="language-bash">cd /tmp/YCSB/
./bin/ycsb run yugabyteSQL -s \
  -P db.properties  \
  -P workloads/workloadb  \
  -p recordcount=10000  \
  -p operationcount=100000  \
  -p threadcount=32  \
  -p maxexecutiontime=180

</code></pre></div>
<h2 id="experiment-on-your-own">Experiment on your own</h2>
<p>Now that you have the YCSB benchmark up and running, you can experiment. Here a some ideas:</p>
<ul>
<li>In Yugabyte Platform, for your universe with your Yugabyte cluster, view the dashboard and metrics while a workload runs.</li>
<li>Double the nodes in the cluster and run the previous benchmark. How does doubling the size of nodes affect the overall throughput metric?</li>
<li>Select a different workload in the workloads directory to run and review how this impacts the dashboard.</li>
</ul>
<h2 id="clean-up">Clean up</h2>
<p>When you are done, you will want to complete the following tasks:</p>
<ul>
<li>Terminate your EC2 instance for running the benchmarks.</li>
<li>Resize your cluster back to just three nodes with a replication factor of 3.</li>
<li>Drop the <code>ycsb</code> database.</li>
<li>If this is your last lab in this course, terminate all of your EC2 instances in AWS.</li>
</ul>
<h2 id="reflection">Reflection</h2>
<p>YCSB is a common benchmark that can show how various databases perform. YCSB for Yugabyte allows you to generate results for specific workloads. By doubling the number of nodes in a Yugabyte cluster, you can demonstrate linear scale.</p>

    </body>
    </html>